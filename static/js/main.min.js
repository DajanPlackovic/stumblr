import{computePosition as t,flip as e,shift as o,offset as l,autoUpdate as a}from"https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.10/+esm";let csrftoken=Cookies.get("csrftoken"),loader=$("#loader").html();function updateModal(t,e,o){$("#general_modal").find(".modal-title").text(t).end().find("btn-secondary").text(e).end().find(".btn-primary").text(o).end().modal("show")}function showErrorOrInfo(t,e){let o,l=e?"bg-danger":"bg-info";e?t.responseJSON&&t.responseJSON.text?o=t.responseJSON.text:(o="An error has occurred",l="bg-danger"):o=t;let a=$(".toast-container");$(a).find(".toast.hide").remove();let n=document.createElement("div");$(n).html($("template#toast").html()).find(".toast").addClass(l).find(".toast-body").html(o);let d=$(n).find(".toast");$(a).append(d);let i=bootstrap.Toast.getOrCreateInstance(d);i.show()}let showError=t=>showErrorOrInfo(t,!0),showInfo=t=>showErrorOrInfo(t,!1);function ajaxWrapper(t,e={}){e.type=t,e.error=t=>{showError(t)},$.ajax(e)}let ajaxGet=(t={})=>ajaxWrapper("GET",t),ajaxPost=(t={})=>{t.headers={"X-CSRFToken":csrftoken},t.mode="same-origin",ajaxWrapper("POST",t)};function renderTemplate(t,e){let{fill:o,condition:l}=t;if(console.log(o),console.log(l),o)for(let a of Object.keys(o))e=e.replaceAll(`|| ${a} ||`,o[a]);if(l)for(let n of Object.keys(l)){let d=`\\{\\| ${n} \\|\\}`,i=RegExp(`${d}([\\S\\s]*)${d}`,"g");e=l[n]?e.replaceAll(i,"$1"):e.replaceAll(i,"")}return e}function deletePost(t){t.preventDefault();let e=this,o=`/delete-post/${$(e).attr("data-post")}`;updateModal("Delete Post","Cancel","Delete"),$("#general_modal .btn-primary").addClass("btn-danger").on("click",()=>{let t=$("#delete_post_form").serialize();ajaxPost({url:o,data:t,success:function t(){$("#general_modal").modal("hide"),$(e).parents(".item-card").remove(),showInfo("Post deleted successfully")},complete:function t(){$("#general_modal .btn-primary").off("click").removeClass("btn-danger")}})});let l=()=>{$("#general_modal .modal-body").html(loader)},a=t=>{let e=$("template#post").html();$("#general_modal .modal-body").html(renderTemplate(t,e))};ajaxGet({url:o,beforeSend:l,success:a})}function editPost(t){t.preventDefault();let e=`/edit-post/${$(this).attr("data-post")}`,o=$(this).parents(".item-card").find(".card-text");updateModal("Edit Post","Cancel","Post"),$("#general_modal .btn-primary").on("click",()=>{let t=$("#create_post_form textarea").val(),l=t=>{$("#general_modal").modal("hide"),o.text(t.text),showInfo("Post successfully edited."),$("#general_modal .btn-primary").off("click")};ajaxPost({url:e,data:{text:t},success:l})});let l=()=>{$("#general_modal .modal-body").html(loader)},a=t=>{$("#general_modal .modal-body").html(t)};ajaxGet({url:e,beforeSend:l,success:a})}function floatMenu(n,d){return a(n,d,()=>{t(n,d,{placement:"bottom",middleware:[l(0),e(),o()]}).then(({x:t,y:e})=>{Object.assign(d.style,{left:`${t}px`,top:`${e}px`})})})}function makeMenuItem(t){return $($("template#collection-menu__item").html()).find('input[type="checkbox"]').attr({id:`col-${t.id}`,value:t.id,"aria-label":`add post to ${t.name}`,checked:t.checked}).end().find("label").attr("for",`col-${t.id}`).text(t.name).end().find('button[data-action="edit_collection"]').attr("data-post",t.id).end()}function makeMenuHtml(t){let e=document.createElement("div");for(let o of($(e).html($("template#collection-menu__container").html()).find(".collection-list"),t)){let l=makeMenuItem(o);$(e).find(".collection-list .list-group").append(l)}return $(e).html()}function addToCollection(){let t=this,e=$(t).next()[0],o=`/collection-menu/${$(t).attr("data-post")}`,l=!1;$(e).show().html(loader);let a=floatMenu(t,e);function n(){$(".add-collection").find("button").hide().end().find("input").show().focus().end().on("submit",function(t){t.preventDefault();let o=$(this).find("input").val(),l=t=>{$(e).find(".collection-list").append(makeMenuItem(t)).find('input[type="text"]').hide().end().end().find(".add-collection input").hide().parent().find("button").show()};ajaxPost({url:"/create-collection",data:{name:o},success:l})})}function d(t){let e=t.currentTarget,o=$(e).parents("li").find('input[type="text"]');$(e).parents(".list-group-item > .row").hide(),$(o).show().focus().on("keypress",t=>{if("Enter"==t.key){let l=$(e).attr("data-post"),a=$(o).val(),n=`edit-collection/${l}`,d=()=>{$(o).hide(),$(e).parents(".list-group-item > .row").show().find("label").text(a)};ajaxPost({url:n,data:{name:a},success:d})}})}ajaxGet({url:o,success:function i(c){let{response:r}=c,s=makeMenuHtml(r);$(e).html(s).find(".add-collection input").hide(),$(e).find(".add-collection button").on("click",n),$(t).off("click"),$(document).on("click",function(n){if(!e.contains(n.target)){if(l){let d=$(e).find(".collection-list").serialize(),i=d||$.param({collection:"empty"},!0);$(e).html(loader);let c=()=>{$(e).hide(),a(),$(t).on("click",addToCollection)};ajaxPost({url:o,data:i,success:c}),l=!1}$(document).off("click")}}),$(e).find('input[type="text"]').hide().end().find('button[data-action="edit_collection"]').on("click",d),l=!0}})}function scroll(t,e){let o=t.getBoundingClientRect(),l=e?"post-list":"collection-list";l+=`?page=${$(t).attr("data-page")}`;let a=e?"#post_container":"#collection_container";if(o.top<document.documentElement.clientHeight+1e3){$(t).remove();let n=t=>{$(a).append(t)};ajaxGet({url:l,success:n})}}function followUnfollow(t,e,o){let l={followed:$(t).attr("data-post")};ajaxPost({url:e,data:l,success:o})}function follow(t){let e=t.currentTarget,o=()=>{$(e).attr("data-action","unfollow"),$(e).text("Unfollow"),$(e).off("click"),$(e).on("click",unfollow)};followUnfollow(e,"/follow/",o)}function unfollow(t){let e=t.currentTarget,o=()=>{$(e).attr("data-action","follow"),$(e).text("Follow"),$(e).off("click"),$(e).on("click",follow)};followUnfollow(e,"/unfollow/",o)}$("#create_post_btn").on("click",()=>{updateModal("Create Post","Cancel","Post");let t="/create-post";$("#general_modal .btn-primary").on("click",()=>{let e=$("#create_post_form").serialize(),o=t=>{$("#general_modal").modal("hide");let e=$("#post_container"),o="Post successfully created.";if(e[0]){let l=$("template#post").html();e.prepend(renderTemplate(t,l));let a=$("#post_container").children().first();a.find('button[data-action="add_to_collection"]').on("click",addToCollection).end().find('button[data-action="edit"]').on("click",editPost).end().find('button[data-action="delete"]').on("click",deletePost)}else o+=`
<a href="/">View here.</a>`;showInfo(o),$("#general_modal .btn-primary").off("click")};ajaxPost({url:t,data:e,success:o})});let e=()=>{$("#general_modal .modal-body").html(loader)},o=t=>{$("#general_modal .modal-body").html(t)};ajaxGet({url:t,beforeSend:e,success:o})}),$('button[data-action="delete"]').on("click",deletePost),$('button[data-action="edit"]').on("click",editPost),$('button[data-action="add_to_collection"]').on("click",addToCollection),$('button[data-action="delete-collection"]').on("click",function(t){t.preventDefault();let e=`/delete-collection/${$(this).attr("data-post")}`;updateModal("Delete Collection","Cancel","Delete"),$("#general_modal .btn-primary").addClass("btn-danger").on("click",()=>{let t=$("#delete_collection_form").serialize(),o=()=>{window.location.replace("")};ajaxPost({url:e,data:t,success:o})});let o=()=>{$("#general_modal .modal-body").html(loader)},l=t=>{$("#general_modal .modal-body").html(t)};ajaxGet({url:e,beforeSend:o,success:l})}),$(".scroll").attr("data-page")&&$(document).on("scroll",()=>{let t=$('.scroll[data-type="posts"]').get(0),e=$('.scroll[data-type="collections"]').get(0);t&&scroll(t,!0),e&&scroll(e,!1)}),$('button[data-action="follow"]').on("click",follow),$('button[data-action="unfollow"]').on("click",unfollow),$("button#theme_btn").on("click",()=>{let t=$("html"),e="/set-theme";if("light"==t.attr("data-bs-theme")){t.attr("data-bs-theme","dark");let o={theme:"dark"};ajaxPost({url:e,data:o})}else{t.attr("data-bs-theme","light");let l={theme:"light"};ajaxPost({url:e,data:l})}});